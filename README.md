# PayFlow — Эмулятор событийной микросервисной архитектуры платёжной системы

## Описание

**PayFlow** — учебно-демонстрационный проект, моделирующий работу финтех-платформы с event-driven микросервисной архитектурой на PHP 8.4 + Swoole.  
Проект показывает, как реализовать асинхронную обработку событий, очереди, масштабирование, аудит, антифрод и аналитику в современных платёжных системах.

### Ключевые особенности
- Асинхронная архитектура на PHP (Swoole).
- Событийное взаимодействие через очереди (RabbitMQ/Redis).
- Несколько микросервисов, каждый со своей бизнес-логикой.
- Конфигурируемый генератор событий (оплаты, возвраты, пополнения, блокировки, подозрительные операции).
- Docker-окружение для изоляции и лёгкого старта.

---

## Архитектура

```mermaid
flowchart LR
    subgraph Event Generator
        E[Event Generator]
    end
    subgraph Queue
        Q(RabbitMQ/Redis)
    end
    subgraph Consumers
        AF[Anti-fraud Service]
        N[Notification Service]
        R[Reconciliation Service]
        AN[Analytics Service]
        AU[Audit Log Service]
    end

    E --> Q
    Q --> AF
    Q --> N
    Q --> R
    Q --> AN
    Q --> AU
    AF -- alerts --> Q
    R -- inconsistencies --> Q
````

**Компоненты:**

* **Event Generator** — генератор событий с REST API для конфигурирования.
* **Очередь** — RabbitMQ или Redis Pub/Sub (fanout/topic).
* **Anti-fraud Service** — анализ и маркировка подозрительных транзакций.
* **Notification Service** — имитация рассылки уведомлений.
* **Reconciliation Service** — сверка событий с внутренней “эталонной” БД.
* **Analytics Service** — сбор и выдача статистики.
* **Audit Log Service** — хранение событий для аудита.

---

## Стек технологий

* PHP 8.4 (Swoole)
* RabbitMQ или Redis (pub/sub)
* PostgreSQL (хранение бизнес-данных, аудита, аналитики)
* Docker, Docker Compose
* Composer, PHPUnit
* Prometheus + Grafana (опционально)
* (Возможно) Vue/React для мониторинга

---

## Структура репозитория

```
.
├── docker/                  # Dockerfiles, скрипты сборки
├── services/                # Код микросервисов (event-generator, anti-fraud, notification и т.д.)
│   ├── event-generator/
│   ├── anti-fraud/
│   ├── notification/
│   ├── reconciliation/
│   ├── analytics/
│   └── audit-log/
├── common/                  # Общие библиотеки, контракты, Value Objects
├── db/                      # Миграции, инициализационные скрипты БД
├── .env.example             # Пример переменных окружения
├── .gitignore
├── docker-compose.yml
├── Makefile                 # Удобные команды для запуска и разработки
└── README.md
```

---

## Быстрый старт

1. **Клонируй репозиторий:**

   ```sh
   git clone https://github.com/your-org/payflow.git
   cd payflow
   ```

2. **Скопируй и настрой .env:**

   ```sh
   cp .env.example .env
   # Проверь и настрой переменные (DB, RabbitMQ, Redis и т.д.)
   ```

3. **Запусти инфраструктуру через Docker Compose:**

   ```sh
   docker compose up --build -d
   ```

4. **Убедись, что все сервисы поднялись:**

   ```sh
   docker compose ps
   ```

5. **Настрой генератор событий (REST API) или запусти тестовый сценарий:**

    * Подробнее смотри документацию внутри `services/event-generator/README.md`.

6. **Следи за логами:**

   ```sh
   docker compose logs -f
   ```

---

## Описание микросервисов

| Сервис          | Назначение                                                        |
|-----------------|-------------------------------------------------------------------|
| event-generator | Генератор событий, REST API для управления нагрузкой и сценариями |
| anti-fraud      | Проверка транзакций по правилам, генерация alert'ов               |
| notification    | Имитация рассылки уведомлений (логирование/webhook)               |
| reconciliation  | Сверка с эталонным хранилищем, поиск расхождений                  |
| analytics       | Сбор и выдача статистики и метрик                                 |
| audit-log       | Аудит, хранение копий всех событий                                |

---

## Как расширять проект

* **Добавить новые типы событий:**
  Расширить payload и схемы событий в генераторе и очереди.
* **Внедрять новые микросервисы:**
  Создать новый сервис в `services/`, подключи к очереди, реализовать свою бизнес-логику.
* **Интегрировать с внешними системами:**
  Реализовать отправку webhooks, интеграции с реальными платежными API, e-mail сервисами и др.
* **Добавить наблюдаемость:**
  Подключить Prometheus/Grafana, логи, алерты.
* **Фронтенд-панель:**
  Реализовать отдельный Web UI для мониторинга (например, на Vue).

---

## Документация

* Каждому микросервису желательно добавить свой `README.md` с:

    * примерами запуска,
    * описанием API/событий,
    * переменными окружения,
    * схемой подключения к очереди и БД.

---

## Тесты

* Запуск unit и интеграционных тестов:

  ```sh
  docker compose exec <service> vendor/bin/phpunit
  ```
* Покрытие кода (если настроено):

  ```sh
  docker compose exec <service> vendor/bin/phpunit --coverage-html=coverage
  ```

---

## Авторство и лицензия

> Проект создан для учебных целей и демонстрации современных инженерных практик в финтех-домене.
> Автор: [Владимир Матковский](https://github.com/vlavlamat)

---

## Контакты и поддержка

* Вопросы и обсуждения: через [Issues](https://github.com/your-org/payflow/issues)
* Предложения и багрепорты приветствуются!

---
